---
title: "Database Variables"
---

```{r, include = FALSE}
motus:::get_sample_data()
options(width = 90)

library(motus)
library(tidyverse)
library(lubridate)
library(kableExtra)
library(glue)

tags <- tagme(176, update = TRUE, new = FALSE, dir = "./data")
```

## Variables

This table lists all variables present in .motus SQLite databases. 

**Notes:**

- `Variable Name` refers to the name of a variable (column/field) in a table
- `Table Name` reflects the tables (actual database tables) where that variable can be found
- `View`s refer to the database 'views' where that variable can be found 
  (views do not contain data themselves, but show data collected and arranged 
  from various tables)
- `Variable Name in View` reflects the name of the variable in a view. 
  Variables often are given new names in views
  - e.g., `alt` is a variable in the `gps` table, 
  but when put into the `alltagsGPS` view, it is called `gpsAlt`
- `Creation Comments` are specific comments about how a particular variable was
  created. This applies mostly to variables which are created on the fly, or, 
  might come for different tables. 
  
> Use the Search bar to narrow results down to a particular variable (e.g., `latitude`),
> table (e.g., `recvDeps`), or view (e.g., `alltags`)


```{r, echo = FALSE}
views <- c("allambigs", "allruns", "allrunsGPS", "alltags", "alltagsGPS")

v_index <- system.file("extdata/fields_glossary.csv", package = "motus") %>%
  read.csv(skip = 1, na.strings = c("NA", ""))

t <- tibble(table = DBI::dbListTables(tags)) %>%
  mutate(name_table = map(table, ~DBI::dbListFields(tags, .))) %>%
  unnest(name_table)

# Get variables in views
t_views <- filter(t, table %in% .env$views) %>%
  rename(view = table, name_view = name_table) %>%
  left_join(v_index, by = "name_view")

# Get variables in tables
t_tables <- filter(t, !table %in% .env$views) %>%
  left_join(v_index, by = "name_table")

desc <- system.file("extdata/fields_description.csv", package = "motus") %>%
  read.csv()



v <- full_join(t_views, t_tables, 
               by = c("name_table", "name_view", "comment"))  %>%
  left_join(desc, by = "name_view") %>%
  arrange(name_table, view) %>%
  select(name_table, table, view, name_view, comment, description) %>%
  mutate(across(.cols = c(name_view, name_table, view, table),
                .fns = ~replace_na(.x, "--")),
         comment = replace_na(comment, "")) %>%
  group_by(name_view, name_table) %>%
  summarize(across(.cols = c(table, view, comment),
                   .fns = ~paste(unique(.x), collapse = ", ")),
            description = unique(description), .groups = "drop") %>%
  mutate(across(.cols = c(name_view, name_table, view, table),
                .fns = ~str_remove_all(.x, "(, --)|(--, )")),
         comment = str_remove_all(comment, ", $"))

# ALL variables should be in a table, OR have a creation comment explaining why
# they don't (e.g., tsCorrected)

## FIX IT! Some variables aren't the same but are grouped together because they
## have the same table name... fix it!

v %>%
  rename("Variable name in tables" = "name_table", 
         "In tables" = "table",
         "Variable name in views" = "name_view",
         "Creation comments" = "comment",
         "Description" = "description", 
         "In views" = "view") %>%
  rename_all(tools::toTitleCase) %>%
  DT::datatable(options = list(pageLength = nrow(v), dom = "ft"), 
                rownames = FALSE)
```

> **What Next?** [Explore all articles](index.html)
