<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>motus design principles • motus</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="motus design principles"><meta property="og:image" content="https://motuswts.github.io/motus/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">motus</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">6.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/motus.html">Get started</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/01-introduction.html">Chapter 1 - Introduction</a></li>
    <li><a class="dropdown-item" href="articles/02-installing-packages.html">Chapter 2 - Installing packages</a></li>
    <li><a class="dropdown-item" href="articles/03-accessing-data.html">Chapter 3 - Accessing detections data</a></li>
    <li><a class="dropdown-item" href="articles/04-deployments.html">Chapter 4 - Tag and receiver deployments</a></li>
    <li><a class="dropdown-item" href="articles/05-data-cleaning.html">Chapter 5 - Data Cleaning</a></li>
    <li><a class="dropdown-item" href="articles/06-exploring-data.html">Chapter 6 - Exploring detections data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="articles/index.html">More articles...</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="articles/troubleshooting.html">Troubleshooting</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Functions</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/MotusWTS/motus/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>motus design principles</h1>
      <small class="dont-index">Source: <a href="https://github.com/MotusWTS/motus/blob/hotfix-bandNumber/CODE_DESIGN.md" class="external-link"><code>CODE_DESIGN.md</code></a></small>
    </div>

<div id="motus-design-principles" class="section level1">

<p>This is a collection of developer notes and is by no means exhaustive or correct</p>
<ul><li><a href="#versioning">Versioning</a></li>
<li><a href="#naming-conventions">Naming Conventions</a></li>
<li><a href="#sqlite-databases">SQLite databases</a></li>
<li><a href="#special-data-downloads">Special data downloads</a></li>
<li><a href="#special-files">Special Files</a></li>
<li><a href="#data-files">Data Files</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="#adding-and-updating">Adding and Updating</a></li>
</ul><div class="section level2">
<h2 id="versioning">Versioning<a class="anchor" aria-label="anchor" href="#versioning"></a></h2>
<p>There 3-4 different <code>motus</code> versions on GitHub at any one time:</p>
<ul><li>
<code>main</code> branch - Current release - e.g., v4.0.3</li>
<li>
<code>beta</code> branch - Current dev relating to the beta api - e.g., v4.0.3.9000</li>
<li>
<code>sandbox</code> branch - Current dev relating to the sandbox api - e.g., v4.0.3.8000</li>
<li>
<code>dev</code>/<code>hotfix-</code> branch - Current quick fixes to merge in to main quickly v4.0.3.9001 (increments one greater than <code>beta</code>)</li>
</ul></div>
<div class="section level2">
<h2 id="naming-conventions">Naming Conventions<a class="anchor" aria-label="anchor" href="#naming-conventions"></a></h2>
<ul><li>Each function in a single file</li>
<li>Exceptions
<ul><li>
<code>utils.R</code> contains internal utility functions</li>
<li>
<code>ensureDBTables.R</code> also contains <code>makeTable()</code> function to create tables</li>
<li>
<code>updateMotusDb.R</code> also contains <code>checkViews()</code> function to check for custom views</li>
</ul></li>
</ul></div>
<div class="section level2">
<h2 id="sqlite-databases">SQLite databases<a class="anchor" aria-label="anchor" href="#sqlite-databases"></a></h2>
<ul><li>Empty SQLite tables created</li>
<li>
<code>ensureDBTables()</code> checks for existing tables and creates empty tables if they don’t exist
<ul><li>some tables are created with <code>makeTables()</code>
</li>
</ul></li>
<li>When changing the data base, the <code><a href="reference/checkVersion.html">checkVersion()</a></code> function compares the date in the <code>admInfo</code> table to the date in the internal data frame <code>sql_versions</code>
<ul><li>
<code>sql_versions</code> is created in <code>./data-raw/updatesql.R</code>
</li>
</ul></li>
<li>If the database is out of date, <code><a href="reference/checkVersion.html">checkVersion()</a></code> applies the SQLite commands in the <code>sql_version</code> data frame to update the data base</li>
<li>Sometimes this involves making a temporary copy of a table, re-creating (with changes) the original table and then copying the data back. In these cases the table structure is created by the <code>makeTables()</code> function (so it can be used by <code>updatesql.R</code> as well as by <code>ensureDBTables()</code> without duplicating the process.</li>
<li>
<code>checkDataVersion()</code> is used to update data versions (not database versions)</li>
<li>Querying and changing the data base is done with wrapper functions: <code>DBI_Query()</code> and <code>DBI_Execute()</code> in <code>utils-wrappers.R</code>. These use <code>glue_sql()</code> to combine statements and insert parameters. Note the use of backticks {<code>var</code>} when inserting table or column names into a statement.</li>
</ul></div>
<div class="section level2">
<h2 id="talk-to-the-api---boxingunboxing-json-parameters">Talk to the API - Boxing/Unboxing JSON parameters<a class="anchor" aria-label="anchor" href="#talk-to-the-api---boxingunboxing-json-parameters"></a></h2>
<ul><li>The API requires that some parameters be boxed (i.e. <code>[parameter]</code>) and some be unboxed (i.e., <code>parameter</code>)</li>
<li>In <code>srvQuery.R</code>, <code><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">jsonlite::toJSON()</a></code> unboxes all single value parameters</li>
<li>If you have a parameter that should NOT be unboxed (usually a single value parameter that could have more), you must go to its <code>srvXXXX.R</code> file, and add <code>I(parameter)</code> (e.g., <code>srvTagsForAmbiguities.R</code>)</li>
<li>However, <code><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I()</a></code> won’t work on <code>NULL</code> values, so we need to get creative if it can have either NULL or values (e.g., <code>srvTagMetadataForProjects.R</code>)</li>
<li>Potentially worth rethinking whether to force boxing via class/type BEFORE gets sent as a parameter…</li>
</ul></div>
<div class="section level2">
<h2 id="special-data-downloads">Special data downloads<a class="anchor" aria-label="anchor" href="#special-data-downloads"></a></h2>
<ul><li>Data that is downloaded by <code>batchID</code> after the main runs download</li>
<li>
<code>pageDataByBatch()</code> is a function that sets up the process</li>
<li>
<code><a href="reference/activity.html">activity()</a></code> and <code><a href="reference/nodeData.html">nodeData()</a></code> set the functions used to get going, but all is passed to <code>pageDataByBatch()</code> as the workhorse function</li>
</ul></div>
<div class="section level2">
<h2 id="special-files">Special Files<a class="anchor" aria-label="anchor" href="#special-files"></a></h2>
<ul><li>
<code>z.onLoad.R</code>
<ul><li>Set session variables (i.e., API links) and motus options (i.e. max batches to get when testing)</li>
</ul></li>
<li>
<code>Motus.R</code> - Define empty session variable (filled with <code>z.onLoad.R</code>)</li>
<li>
<code>motus-pkg.R</code> - Help file documentation for the motus package</li>
</ul></div>
<div class="section level2">
<h2 id="data-files">Data Files<a class="anchor" aria-label="anchor" href="#data-files"></a></h2>
<ul><li>Sample data for examples and testing, created in <code>./data-raw/sample_data.R</code>
<ul><li>INCOMPLETE</li>
</ul></li>
<li><code>updatesql.R</code></li>
</ul></div>
<div class="section level2">
<h2 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h2>
<ul><li>
<code>sample_auth()</code> is used for automatic tests involving the motus.sample project 176</li>
<li>
<code>local_auth()</code> is used to load locally stored credentials for private projects to test local functionality</li>
<li>
<code>skip_if_not_auth()</code> is used in tests to a) implement local authorizations if present and b) skip the test if they are not present</li>
</ul><p><code>motusUpdateTagDB()</code> and <code>pageDataByBatch()</code> have checks in them that will halt a download after <code>getOption("motus.test.max")</code> batches IF in a testing environment. This way testing can be done much more quickly on a variety of projects/receivers.</p>
<ul><li>
<code>is_testing()</code> is an internal function that checks if a test is being run</li>
<li>
<code>set_testing()</code> is an internal function for declaring that testing is being performed (for interactive testing, use <code>set_testing()</code> to start and <code>set_testing(set = FALSE)</code> to stop)</li>
</ul></div>
<div class="section level2">
<h2 id="adding-and-updating">Adding and Updating<a class="anchor" aria-label="anchor" href="#adding-and-updating"></a></h2>
<div class="section level3">
<h3 id="adding-a-new-fieldcolumn">Adding a new field/column<a class="anchor" aria-label="anchor" href="#adding-a-new-fieldcolumn"></a></h3>
<ul><li>Source <code>data-raw/internal_data.R</code>, this will run <code>data-raw/field_names.R</code> which should grab the new field name from the server and add it to the list of tables
<ul><li>If there’s a special SQL command, however, you’ll have add that by hand to the table in <code>data-raw/field_names.R</code>
</li>
</ul></li>
<li>Add update to <code>data-raw/updatesql.R</code> (run script, re-build package locally)</li>
<li>Add test to make sure new field is added (<code>tests/testthat/test_02_sqlite.R</code>) and filled with data (<code>tests/testthat/test_07_data_returned.R</code>)</li>
<li>Update internal data <code>source("data-raw/sample_data.R")</code>
</li>
<li>Update NEWS.md</li>
<li>Run tests</li>
<li>Push!</li>
</ul></div>
<div class="section level3">
<h3 id="adding-a-new-table">Adding a new table<a class="anchor" aria-label="anchor" href="#adding-a-new-table"></a></h3>
<ul><li>Add a section to <code>data-raw/field_names.R</code> pulling the new table data from the server and adding it to the list of tables</li>
<li>In <code>ensureDBTables.R</code> either add it to the list of tables that are created empty, or add it to the section where tables are created and then immediately filled with data (and add the data that should fill it).</li>
<li>If the table has <code>batchIDs</code> add it to the list of tables in which to remove deprecated <code>batchIDs</code> in <code><a href="reference/deprecateBatches.html">deprecateBatches()</a></code> in the <code>deprecateBatches.R</code> file.</li>
<li>You <strong>shouldn’t</strong> need to add a section to <code>data-raw/updatesql.R</code>
</li>
<li>Add test to make sure new field is added (<code>tests/testthat/test_02_sqlite.R</code>) and filled with data (<code>tests/testthat/test_07_data_returned.R</code>)</li>
<li>Update internal data <code>source("data-raw/sample_data.R")</code>
</li>
<li>Update NEWS.md</li>
<li>Push!</li>
</ul></div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Birds Canada, John Brzustowski, Denis Lepage.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

